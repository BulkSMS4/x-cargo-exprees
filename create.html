<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>📄 X-Cargo Express — Create Invoice</title>
  <style>
    :root{--primary:#007bff}
    body{font-family:Inter, "Segoe UI", Roboto, Arial; background:#f5f7fb; color:#222; margin:0; padding:24px;}
    h1{color:var(--primary); text-align:center; margin-bottom:18px}
    form { max-width:900px; margin:0 auto 18px; background:#fff; padding:18px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.06); }
    label{display:block; margin-top:12px; font-weight:600}
    input[type="text"], input[type="date"], input[type="number"], input[type="color"], select, textarea, input[type="file"] {
      width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #d8dce3; font-size:14px;
    }
    textarea{min-height:70px; resize:vertical}
    .row { display:flex; gap:12px; }
    .col { flex:1; }
    .small { max-width:220px; }
    button { background:var(--primary); color:#fff; border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:700; margin-top:16px; width:100%;}
    button.secondary { background:#444; width:auto; padding:8px 12px; margin-left:8px; }
    .flex { display:flex; gap:8px; align-items:center; }
    .note { font-size:13px; color:#666; margin-top:6px; }

    /* invoice / receipt */
    .invoice { display:none; max-width:900px; margin:20px auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.06); }
    .inv-header { display:flex; gap:16px; align-items:center; border-bottom:2px solid #eef3fb; padding-bottom:12px; }
    .inv-logo { width:84px; height:84px; object-fit:contain; border-radius:8px; background:#fff; border:1px solid #eee; }
    .inv-title { margin-left:6px; }
    .inv-title h2{ margin:0; color:var(--primary) }
    .inv-meta { margin-left:auto; text-align:right; font-size:13px; color:#555 }
    table.inv-table { width:100%; border-collapse:collapse; margin-top:14px; }
    table.inv-table th, table.inv-table td { padding:10px; border:1px solid #eee; text-align:left; font-size:14px; }
    .status-badge { display:inline-block; padding:6px 12px; border-radius:20px; color:#fff; font-weight:700; margin-top:8px; }
    .warning { margin-top:12px; font-weight:700; padding:8px 10px; border-radius:8px; display:inline-block;}
    .images { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; }
    .images img { width:180px; height:120px; object-fit:cover; border-radius:8px; border:1px solid #eee; }

    .upload-status { text-align:center; margin-top:10px; font-size:14px; color:#007bff; font-weight:700; }
    .actions { display:flex; gap:8px; margin-top:16px; flex-wrap:wrap; }
    .actions button { width:auto; }

    /* responsive */
    @media (max-width:720px){
      .row { flex-direction:column; }
      .inv-header { flex-direction:column; align-items:flex-start }
      .inv-meta { margin-left:0; text-align:left; margin-top:8px; }
    }
  </style>
  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

  <h1>📄 X-Cargo Express — Create Invoice</h1>

  <form id="createForm" autocomplete="off">
    <div class="row">
      <div class="col">
        <label>Tracking ID <span class="note">(auto if blank)</span></label>
        <input id="trackingId" type="text" placeholder="e.g. XCE123456">
      </div>
      <div class="col small">
        <label>Shipment Date</label>
        <input id="shipmentDate" type="date">
      </div>
      <div class="col small">
        <label>Expected Delivery</label>
        <input id="expectedDate" type="date">
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Sender</label>
        <input id="sender" type="text" placeholder="e.g. John Smith / New York, USA">
      </div>
      <div class="col">
        <label>Receiver</label>
        <input id="receiver" type="text" placeholder="e.g. Mary Johnson / London, UK">
      </div>
    </div>

    <label>Delivery Address</label>
    <textarea id="address" placeholder="e.g. 22B Baker Street, London, W1U 3BW"></textarea>

    <div class="row">
      <div class="col small">
        <label>Weight</label>
        <input id="weight" type="text" placeholder="e.g. 12.5 kg">
      </div>
      <div class="col small">
        <label>Quantity</label>
        <input id="quantity" type="number" min="1" value="1" placeholder="e.g. 3">
      </div>
      <div class="col">
        <label>Description</label>
        <input id="description" type="text" placeholder="e.g. Fragile electronic items">
      </div>
    </div>

    <h3 style="margin-top:14px; color:var(--primary)">Status & Warning</h3>

    <div class="row">
      <div class="col">
        <label>Status</label>
        <select id="status">
          <option>Pending</option>
          <option>Processing</option>
          <option>In Transit</option>
          <option>On Hold</option>
          <option>Suspended</option>
          <option>Delivered</option>
          <option>Not Delivered Yet</option>
        </select>
      </div>
      <div class="col small">
        <label>Status Color</label>
        <input id="statusColor" type="color" value="#007bff">
      </div>
    </div>

    <div style="margin-top:10px">
      <label><input id="showWarning" type="checkbox"> Show Warning Message</label>
      <textarea id="warningText" placeholder="e.g. ⚠️ Handle with care — fragile"></textarea>
      <div style="max-width:200px;">
        <label>Warning Color</label>
        <input id="warningColor" type="color" value="#ff0000">
      </div>
    </div>

    <h3 style="margin-top:14px; color:var(--primary)">Images</h3>
    <div class="row">
      <div class="col">
        <label>Company Logo (optional)</label>
        <input id="logoUpload" type="file" accept="image/*">
      </div>
      <div class="col">
        <label>Package Images (optional — multiple)</label>
        <input id="packageImages" type="file" accept="image/*" multiple>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div class="col small">
        <button id="saveBtn" type="submit">Save & Show Invoice</button>
      </div>
      <div class="col small">
        <button id="clearBtn" type="button" class="secondary">Clear Form</button>
      </div>
    </div>

    <p class="note">Tip: invoice appears immediately. Files upload in background and will update the saved record when done.</p>
  </form>

  <!-- upload status -->
  <div id="uploadStatus" class="upload-status" style="display:none"></div>

  <!-- Invoice / Receipt -->
  <section id="invoice" class="invoice" aria-live="polite">
    <div class="inv-header">
      <img id="invLogo" class="inv-logo" src="" alt="Company logo" />
      <div class="inv-title">
        <h2>📦 X-Cargo Express — Invoice</h2>
        <div style="color:#555; font-size:13px">123 Express Avenue, Florida, USA<br/>support@xcargoexpress.com | +1-800-555-XCEX</div>
      </div>
      <div class="inv-meta" id="invMeta"></div>
    </div>

    <div id="statusWrap" style="margin-top:10px"></div>

    <table class="inv-table" style="margin-top:14px">
      <tbody>
        <tr><th>Tracking ID</th><td id="iTracking"></td></tr>
        <tr><th>Sender</th><td id="iSender"></td></tr>
        <tr><th>Receiver</th><td id="iReceiver"></td></tr>
        <tr><th>Address</th><td id="iAddress"></td></tr>
        <tr><th>Shipment Date</th><td id="iShip"></td></tr>
        <tr><th>Expected Delivery</th><td id="iExpected"></td></tr>
        <tr><th>Weight</th><td id="iWeight"></td></tr>
        <tr><th>Quantity</th><td id="iQuantity"></td></tr>
        <tr><th>Description</th><td id="iDesc"></td></tr>
      </tbody>
    </table>

    <div id="iWarning" style="margin-top:12px"></div>
    <div id="iImages" class="images"></div>

    <div class="actions">
      <button id="printBtn">🖨 Print Invoice</button>
      <button id="pdfBtn">📥 Download PDF</button>
      <button id="saveGalleryBtn">🖼 Save to Gallery</button>
    </div>
  </section>

  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getDatabase, ref as dbRef, set as dbSet } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";

    // Firebase config (kept as your project)
    const firebaseConfig = {
      apiKey: "AIzaSyBLYDpP68NlfYGE1O9DafgrmFBUlgpoYeI",
      authDomain: "x-cargo-exprees.firebaseapp.com",
      databaseURL: "https://x-cargo-exprees-default-rtdb.firebaseio.com",
      projectId: "x-cargo-exprees",
      storageBucket: "x-cargo-exprees.appspot.com",
      messagingSenderId: "1082201867958",
      appId: "1:1082201867958:web:d6600fbc82085b0b62c817"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // DOM
    const createForm = document.getElementById("createForm");
    const saveBtn = document.getElementById("saveBtn");
    const invoice = document.getElementById("invoice");
    const uploadStatus = document.getElementById("uploadStatus");

    // Elements for invoice fill
    const invLogo = document.getElementById("invLogo");
    const invMeta = document.getElementById("invMeta");
    const iTracking = document.getElementById("iTracking");
    const iSender = document.getElementById("iSender");
    const iReceiver = document.getElementById("iReceiver");
    const iAddress = document.getElementById("iAddress");
    const iShip = document.getElementById("iShip");
    const iExpected = document.getElementById("iExpected");
    const iWeight = document.getElementById("iWeight");
    const iQuantity = document.getElementById("iQuantity");
    const iDesc = document.getElementById("iDesc");
    const statusWrap = document.getElementById("statusWrap");
    const iWarning = document.getElementById("iWarning");
    const iImages = document.getElementById("iImages");

    // helpers
    const createObjectURL = (file) => URL.createObjectURL(file);

    function showInvoice(data, previewImgs = []) {
      invoice.style.display = "block";
      iTracking.textContent = data.trackingId;
      iSender.textContent = data.sender;
      iReceiver.textContent = data.receiver;
      iAddress.textContent = data.address;
      iShip.textContent = data.shipmentDate || "-";
      iExpected.textContent = data.expectedDate || "-";
      iWeight.textContent = data.weight || "-";
      iQuantity.textContent = data.quantity || "-";
      iDesc.textContent = data.description || "-";

      // status badge with chosen color
      statusWrap.innerHTML = `<div class="status-badge" style="background:${data.statusColor || '#007bff'}">${data.status || 'Pending'}</div>`;

      // warning
      if (data.showWarning && data.warningText) {
        iWarning.innerHTML = `<div class="warning" style="color:${data.warningColor || '#ff0000'}">${data.warningText}</div>`;
      } else {
        iWarning.innerHTML = "";
      }

      // logo (preview or final)
      if (data.logoURL) invLogo.src = data.logoURL;
      else invLogo.src = data.logoPreview || "";

      // images (preview or final)
      iImages.innerHTML = "";
      if (data.imageURLs && data.imageURLs.length) {
        data.imageURLs.forEach(url => {
          iImages.innerHTML += `<img src="${url}" alt="Package image">`;
        });
      } else if (previewImgs && previewImgs.length) {
        previewImgs.forEach(src => {
          iImages.innerHTML += `<img src="${src}" alt="Preview image">`;
        });
      }
    }

    // Background upload function: returns object with logoURL and imageURLs
    async function uploadFilesInBackground(trackingId, logoFile, packageFiles, onProgress) {
      const result = { logoURL: "", imageURLs: [] };

      try {
        // upload logo
        if (logoFile) {
          const name = `logos/${Date.now()}_${Math.random().toString(36).slice(2)}_${logoFile.name}`;
          const ref = storageRef(storage, name);
          await uploadBytes(ref, logoFile);
          result.logoURL = await getDownloadURL(ref);
        }

        // upload package images sequentially (or you can parallelize)
        const promises = [];
        for (const file of packageFiles) {
          const name = `packages/${Date.now()}_${Math.random().toString(36).slice(2)}_${file.name}`;
          const refImg = storageRef(storage, name);
          // push promise but await all with Promise.all for concurrency
          promises.push(uploadBytes(refImg, file).then(() => getDownloadURL(refImg)));
        }

        if (promises.length) {
          const urls = await Promise.all(promises);
          result.imageURLs = urls;
        }

      } catch (err) {
        console.error("Upload error:", err);
        throw err;
      }

      return result;
    }

    // Save form: instant show, background upload -> update DB when done
    createForm.addEventListener("submit", async (ev) => {
      ev.preventDefault();

      // collect fields
      const trackingField = document.getElementById("trackingId");
      let trackingId = trackingField.value.trim();
      if (!trackingId) trackingId = "XCE" + Math.floor(100000 + Math.random() * 900000);

      const data = {
        trackingId,
        sender: document.getElementById("sender").value.trim(),
        receiver: document.getElementById("receiver").value.trim(),
        address: document.getElementById("address").value.trim(),
        shipmentDate: document.getElementById("shipmentDate").value,
        expectedDate: document.getElementById("expectedDate").value,
        weight: document.getElementById("weight").value.trim(),
        quantity: document.getElementById("quantity").value,
        description: document.getElementById("description").value.trim(),
        status: document.getElementById("status").value,
        statusColor: document.getElementById("statusColor").value,
        warningText: document.getElementById("warningText").value.trim(),
        warningColor: document.getElementById("warningColor").value,
        showWarning: document.getElementById("showWarning").checked,
        logoURL: "",      // will be filled after upload
        imageURLs: []    // will be filled after upload
      };

      // immediate local previews (object URLs)
      const logoFile = document.getElementById("logoUpload").files[0] || null;
      const packageFileList = Array.from(document.getElementById("packageImages").files || []);
      const previewImgs = [];
      if (logoFile) data.logoPreview = createObjectURL(logoFile);
      for (const f of packageFileList) previewImgs.push(createObjectURL(f));

      // show invoice instantly (no wait)
      showInvoice(data, previewImgs);

      // Show visible upload status
      uploadStatus.style.display = "block";
      uploadStatus.textContent = "⏳ Uploading files in background...";

      // Start background upload & DB save
      try {
        const uploadResult = await uploadFilesInBackground(trackingId, logoFile, packageFileList);
        // update data with actual URLs
        data.logoURL = uploadResult.logoURL || data.logoURL;
        data.imageURLs = uploadResult.imageURLs || [];

        // save final record to DB
        await dbSet(dbRef(db, "packages/" + trackingId), data);

        // replace previews with final urls (if available)
        if (data.logoURL) invLogo.src = data.logoURL;
        if (data.imageURLs && data.imageURLs.length) {
          iImages.innerHTML = "";
          data.imageURLs.forEach(url => {
            iImages.innerHTML += `<img src="${url}" alt="Package image">`;
          });
        }

        uploadStatus.textContent = "✅ Files uploaded and saved.";
        setTimeout(()=> uploadStatus.style.display = "none", 2500);

      } catch (err) {
        uploadStatus.textContent = "❌ Upload failed: " + (err.message || err);
        console.error(err);
      }
    });

    // Clear form
    document.getElementById("clearBtn").addEventListener("click", () => {
      createForm.reset();
      invoice.style.display = "none";
      uploadStatus.style.display = "none";
      // revoke preview object urls optionally
    });

    // Print immediately (prints invoice section)
    document.getElementById("printBtn").addEventListener("click", () => {
      window.print();
    });

    // Download PDF (uses html2canvas + jsPDF)
    document.getElementById("pdfBtn").addEventListener("click", async () => {
      const element = document.getElementById("invoice");
      const canvas = await html2canvas(element, { scale: 2 });
      const imgData = canvas.toDataURL("image/png");
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "mm", "a4");
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
      pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
      pdf.save(`Invoice-${document.getElementById("iTracking").textContent || 'package'}.pdf`);
    });

    // Save to gallery / download image
    document.getElementById("saveGalleryBtn").addEventListener("click", async () => {
      const element = document.getElementById("invoice");
      const canvas = await html2canvas(element, { scale: 2 });
      const url = canvas.toDataURL("image/png");
      const link = document.createElement("a");
      link.href = url;
      link.download = `Invoice-${document.getElementById("iTracking").textContent || 'package'}.png`;
      document.body.appendChild(link);
      link.click();
      link.remove();
    });

    // Small helper: ensure dbRef is available
    function dbRef(dbInstance, path) {
      return dbRefOriginal(dbInstance, path);
    }
    // We need to access original dbRef name; workaround: import alias
    import { ref as dbRefOriginal } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
  </script>
</body>
</html>
