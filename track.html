<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>X-Cargo Express ‚Äì Track Your Package</title>
<style>
  body{font-family:Inter,"Segoe UI",Arial;background:#f4f6fb;color:#222;padding:20px;max-width:920px;margin:auto}
  h1{text-align:center;color:#004080;margin-bottom:20px}
  .search{display:flex;gap:8px;justify-content:center;margin:12px 0 20px}
  input{padding:12px;width:60%;border-radius:6px;border:1px solid #ccc;font-size:15px}
  button{padding:12px 14px;border-radius:6px;border:none;background:#004080;color:#fff;cursor:pointer;font-weight:700}
  #result{background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.06);margin-top:18px;display:none}
  .logo img{max-width:140px;display:block;margin:0 auto 8px}
  .status{ text-align:center;margin:10px 0 }
  .status-badge{display:inline-block;padding:6px 12px;border-radius:18px;color:#fff;font-weight:700}
  .warning{margin:10px 0;padding:10px;border-radius:8px;font-weight:700}
  .images{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:12px}
  .images img{width:180px;height:120px;object-fit:cover;border-radius:8px;border:1px solid #eee}
  .field{margin-bottom:8px}
  .field strong{color:#004080}
  .not-found{text-align:center;color:#f00;font-weight:700;margin-top:20px}
  @media (max-width:720px){ input{width:100%} .search{flex-direction:column;align-items:center}}
</style>
</head>
<body>
<h1>üì¶ Track Your Package üõçÔ∏è</h1>

<div class="search">
  <input id="trackingId" placeholder="Enter your tracking ID (e.g. XCE1234567890)">
  <button onclick="trackPackage()">Track</button>
</div>

<div id="result"></div>
<p id="notFound" class="not-found" style="display:none">‚ùå No package found for that Tracking ID.</p>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getDatabase, ref as dbRef, get, child } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBLYDpP68NlfYGE1O9DafgrmFBUlgpoYeI",
    authDomain: "x-cargo-exprees.firebaseapp.com",
    databaseURL: "https://x-cargo-exprees-default-rtdb.firebaseio.com",
    projectId: "x-cargo-exprees",
    storageBucket: "x-cargo-exprees.appspot.com",
    messagingSenderId: "1082201867958",
    appId: "1:1082201867958:web:d6600fbc82085b0b62c817"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // helper escape
  function escapeHtml(s) {
    if (!s && s !== 0) return '';
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  async function findPackageByIdOrField(id) {
    // try direct path first
    const directSnap = await get(child(dbRef(db), 'packages/' + id));
    if (directSnap.exists()) return directSnap.val();

    // else search all packages for trackingId match (case-insensitive)
    const allSnap = await get(child(dbRef(db), 'packages'));
    if (!allSnap.exists()) return null;
    let found = null;
    allSnap.forEach(item => {
      const d = item.val();
      if (d && d.trackingId && d.trackingId.toLowerCase() === id.toLowerCase()) {
        found = d;
      }
    });
    return found;
  }

  window.trackPackage = async function() {
    const id = document.getElementById('trackingId').value.trim();
    const res = document.getElementById('result');
    const notFound = document.getElementById('notFound');
    res.style.display = 'none';
    notFound.style.display = 'none';
    if (!id) return alert('Please enter a tracking ID.');

    try {
      const data = await findPackageByIdOrField(id);
      if (!data) {
        notFound.style.display = 'block';
        return;
      }

      // render
      let html = '';
      if (data.logoURL) html += `<div class="logo"><img src="${data.logoURL}" alt="Logo"></div>`;
      html += `<h2 style="text-align:center;color:#004080;margin-top:4px">Package Details</h2>`;
      const sc = data.statusColor || '#007bff';
      html += `<div class="status"><span class="status-badge" style="background:${sc}">${escapeHtml(data.status || 'Pending')}</span></div>`;

      html += `<div class="field"><strong>Tracking ID:</strong> ${escapeHtml(data.trackingId || id)}</div>`;
      html += `<div class="field"><strong>Title:</strong> ${escapeHtml(data.title || '-')}</div>`;
      html += `<div class="field"><strong>Sender:</strong> ${escapeHtml(data.senderName || '-') } ‚Äî ${escapeHtml(data.senderEmail || '') } ‚Äî ${escapeHtml(data.senderPhone || '') } ‚Äî ${escapeHtml(data.senderLocation || '')}</div>`;
      html += `<div class="field"><strong>Receiver:</strong> ${escapeHtml(data.receiverName || '-') } ‚Äî ${escapeHtml(data.receiverEmail || '') } ‚Äî ${escapeHtml(data.receiverPhone || '') } ‚Äî ${escapeHtml(data.receiverLocation || '')}</div>`;
      html += `<div class="field"><strong>Address:</strong> ${escapeHtml(data.address || '-')}</div>`;
      html += `<div class="field"><strong>Shipment Date:</strong> ${escapeHtml(data.shipmentDate || '-')}</div>`;
      html += `<div class="field"><strong>Expected Delivery:</strong> ${escapeHtml(data.expectedDate || '-')}</div>`;
      html += `<div class="field"><strong>Weight:</strong> ${escapeHtml(data.weight || '-')}</div>`;
      html += `<div class="field"><strong>Quantity:</strong> ${escapeHtml(data.quantity || '-')}</div>`;
      html += `<div class="field"><strong>Description:</strong> ${escapeHtml(data.description || '-')}</div>`;

      if (data.showWarning && data.warningText) {
        html += `<div class="warning" style="color:${data.warningColor || '#ff0000'}">${escapeHtml(data.warningText)}</div>`;
      }

      // images (all)
      if (data.imageURLs && data.imageURLs.length) {
        html += `<div class="images">`;
        data.imageURLs.forEach(u => html += `<img src="${u}" alt="Package image">`);
        html += `</div>`;
      }

      res.innerHTML = html;
      res.style.display = 'block';
    } catch (err) {
      console.error(err);
      alert('Error retrieving package. Try again later.');
    }
  };

  // auto-check URL param ?id=...
  (function() {
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    if (id) {
      document.getElementById('trackingId').value = id;
      setTimeout(() => trackPackage(), 300);
    }
  })();
</script>
</body>
</html>
