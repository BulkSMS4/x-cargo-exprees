<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Invoice — X-Cargo Express</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
  body{font-family:Inter,system-ui,Segoe UI,Arial;background:#f6f8fb;margin:0;padding:24px;color:#111}
  .wrap{max-width:900px;margin:0 auto}
  .card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 10px 30px rgba(20,20,50,0.06)}
  .inv-header{display:flex;align-items:center;gap:16px;border-bottom:1px solid #eef2f7;padding-bottom:12px}
  .inv-logo{width:84px;height:84px;object-fit:contain;border-radius:8px;background:#fff;border:1px solid #f0f2f6;padding:6px}
  .inv-title h2{margin:0;color:#0b63d6}
  .inv-meta{margin-left:auto;text-align:right;color:#6b7280;font-size:13px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:10px;border:1px solid #f0f2f6;text-align:left}
  .status-badge{display:inline-block;padding:8px 14px;border-radius:20px;color:#fff;font-weight:700}
  .images{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;justify-content:center}
  .images img{width:200px;height:140px;object-fit:cover;border-radius:8px;border:1px solid #eee}
  .muted{color:#6b7280}
  @media print {.no-print{display:none}}
</style>
</head>
<body>
<div class="wrap">
  <div id="invoiceCard" class="card">Loading invoice...</div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getDatabase, ref as dbRef, get, child } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBLYDpP68NlfYGE1O9DafgrmFBUlgpoYeI",
    authDomain: "x-cargo-exprees.firebaseapp.com",
    databaseURL: "https://x-cargo-exprees-default-rtdb.firebaseio.com",
    projectId: "x-cargo-exprees",
    storageBucket: "x-cargo-exprees.appspot.com",
    messagingSenderId: "1082201867958",
    appId: "1:1082201867958:web:d6600fbc82085b0b62c817"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  function escapeHtml(s){ if(!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  async function loadInvoice() {
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    const el = document.getElementById('invoiceCard');
    if (!id) { el.innerHTML = '<div class="muted">No tracking id supplied. Use ?id=TRACKINGID</div>'; return; }

    try {
      const snap = await get(child(dbRef(db), 'packages/' + id));
      if (!snap.exists()) { el.innerHTML = '<div class="muted">No package found for ID: '+escapeHtml(id)+'</div>'; return; }
      const d = snap.val();
      const meta = new Date(d.createdAt || Date.now()).toLocaleString();
      let html = `
        <div class="inv-header">
          <img class="inv-logo" src="${d.logoURL || ''}" alt="Logo">
          <div>
            <h2>X-Cargo Express — Invoice</h2>
            <div class="muted">123 Express Avenue, Florida, USA</div>
          </div>
          <div class="inv-meta">Created: ${meta}<br>Tracking: ${escapeHtml(d.trackingId||id)}</div>
        </div>

        <div style="margin-top:12px"><span class="status-badge" style="background:${d.statusColor||'#007bff'}">${escapeHtml(d.status||'Pending')}</span></div>

        <table>
          <tbody>
            <tr><th>Tracking ID</th><td>${escapeHtml(d.trackingId)}</td></tr>
            <tr><th>Title</th><td>${escapeHtml(d.title)}</td></tr>
            <tr><th>Sender</th><td>${escapeHtml(d.senderName)} — ${escapeHtml(d.senderEmail)} — ${escapeHtml(d.senderPhone)} — ${escapeHtml(d.senderLocation)}</td></tr>
            <tr><th>Receiver</th><td>${escapeHtml(d.receiverName)} — ${escapeHtml(d.receiverEmail)} — ${escapeHtml(d.receiverPhone)} — ${escapeHtml(d.receiverLocation)}</td></tr>
            <tr><th>Address</th><td>${escapeHtml(d.address)}</td></tr>
            <tr><th>Shipment Date</th><td>${escapeHtml(d.shipmentDate)}</td></tr>
            <tr><th>Expected Delivery</th><td>${escapeHtml(d.expectedDate)}</td></tr>
            <tr><th>Weight</th><td>${escapeHtml(d.weight)}</td></tr>
            <tr><th>Quantity</th><td>${escapeHtml(d.quantity)}</td></tr>
            <tr><th>Description</th><td>${escapeHtml(d.description)}</td></tr>
          </tbody>
        </table>
      `;

      if (d.showWarning && d.warningText) {
        html += `<div style="margin-top:12px;color:${d.warningColor||'#ff0000'};font-weight:700">${escapeHtml(d.warningText)}</div>`;
      }

      if (d.imageURLs && d.imageURLs.length) {
        html += `<div class="images">`;
        d.imageURLs.forEach(u => html += `<img src="${u}" alt="Package image">`);
        html += `</div>`;
      }

      el.innerHTML = html;
    } catch (err) {
      console.error(err);
      el.innerHTML = '<div class="muted">Error loading invoice. Try again later.</div>';
    }
  }

  loadInvoice();
</script>
</body>
</html>
