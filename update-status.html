<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üöö X-Cargo Express - Update Package Status</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {font-family:"Segoe UI",sans-serif;background:#f5f7fb;color:#333;padding:25px;}
h2{text-align:center;margin-bottom:25px;color:#007bff;}
form{max-width:650px;margin:auto;background:#fff;padding:25px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
label{display:block;margin-top:10px;font-weight:500;}
input,select,textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:5px;font-size:15px;}
button{background:#007bff;color:#fff;border:none;padding:12px;border-radius:6px;width:100%;margin-top:20px;font-size:16px;cursor:pointer;transition:0.3s;}
button:hover{background:#0056b3;}
.receipt{display:none;background:#fff;padding:25px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);max-width:700px;margin:30px auto;position:relative;}
.header{text-align:center;border-bottom:2px solid #007bff;padding-bottom:10px;margin-bottom:15px;}
.header img{width:80px;height:auto;display:block;margin:0 auto 8px;}
.header h2{margin:5px 0;}
.header p{margin:0;font-size:13px;color:#666;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
table td,table th{padding:8px;border:1px solid #ccc;font-size:14px;}
table th{background:#f1f1f1;text-align:left;}
.status-box{text-align:center;margin-top:10px;}
.status-badge{display:inline-block;padding:6px 14px;border-radius:20px;color:#fff;font-weight:bold;}
.warning-box{text-align:center;font-weight:bold;margin-top:10px;}
.images{text-align:center;margin-top:15px;}
.images img{max-width:220px;margin:8px;border-radius:6px;}
.actions{text-align:center;margin-top:15px;}
.actions button{width:auto;margin:5px;padding:10px 15px;border-radius:6px;}
.actions .pdf{background:#ffc107;}
.actions .print{background:#17a2b8;}
.actions .img{background:#28a745;}
.picker-container{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;justify-content:center;}
.picker-container img{width:100px;cursor:pointer;border:2px solid transparent;border-radius:6px;transition:0.2s;}
.picker-container img.selected{border-color:#007bff;}
.signature-canvas{border:1px solid #ccc;margin-top:10px;cursor:crosshair;}
.draggable-stamp{position:absolute;width:100px;cursor:move;z-index:1000;}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<h2>üöö Update Package Status</h2>

<form id="statusForm">
<label>Enter Tracking ID</label>
<input type="text" id="trackingId" placeholder="e.g. XCE123456" required>

<button type="button" id="fetchBtn">üîç Search Package</button>

<label>Change Status</label>
<select id="status">
<option>Pending</option>
<option>Processing</option>
<option>In Transit</option>
<option>On Hold</option>
<option>Suspended</option>
<option>Delivered</option>
<option>Not Delivered Yet</option>
</select>

<label>Custom Status Color</label>
<input type="color" id="statusColor" value="#007bff">

<h3>‚ö†Ô∏è Warning Settings</h3>
<label><input type="checkbox" id="showWarning"> Show Warning Message</label>
<textarea id="warningText" placeholder="‚ö†Ô∏è Failure to verify may result in account lock!"></textarea>
<label>Warning Text Color</label>
<input type="color" id="warningColor" value="#ff0000">

<h3>üñã Add Signature</h3>
<canvas id="signatureCanvas" class="signature-canvas" width="400" height="150"></canvas>
<label>Pick Signature Color</label>
<input type="color" id="signatureColor" value="#000000">

<h3>üè∑ Add Stamp</h3>
<input type="file" id="uploadStamp" accept="image/*">
<div class="picker-container" id="stampPicker">
  <img src="https://i.postimg.cc/3x1sZsLz/approved.png" alt="Approved" class="stamp">
  <img src="https://i.postimg.cc/d3vY7cQm/rejected.png" alt="Rejected" class="stamp">
</div>

<button type="submit" id="updateBtn" disabled>‚úÖ Update Status</button>
</form>

<div id="receipt" class="receipt">
<div class="header">
<img id="headerLogo" src="" alt="Company Logo">
<h2>X-Cargo Express</h2>
<p>123 Express Avenue, Florida, USA</p>
<p>Email: support@xcargoexpress.com | Tel: +1-800-555-XCEX</p>
</div>

<div class="status-box" id="statusBox"></div>

<table>
<tr><th>Tracking ID</th><td id="rTracking"></td></tr>
<tr><th>Sender</th><td id="rSender"></td></tr>
<tr><th>Receiver</th><td id="rReceiver"></td></tr>
<tr><th>Address</th><td id="rAddress"></td></tr>
<tr><th>Shipment Date</th><td id="rShip"></td></tr>
<tr><th>Expected Delivery</th><td id="rExpected"></td></tr>
<tr><th>Weight</th><td id="rWeight"></td></tr>
<tr><th>Quantity</th><td id="rQuantity"></td></tr>
<tr><th>Description</th><td id="rDesc"></td></tr>
</table>

<div id="warningBox"></div>
<div class="images" id="imageSection"></div>
<div id="stampsContainer" style="position:relative; min-height:50px;"></div>
<div id="selectedSignature" style="text-align:center; margin-top:10px;"></div>

<div class="actions">
<button class="print" onclick="window.print()">üñ® Print</button>
<button class="pdf" id="downloadPDF">‚¨á PDF</button>
<button class="img" id="saveImage">üñº Save Image</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getDatabase, ref, get, child, update } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

const firebaseConfig = {
apiKey: "AIzaSyBLYDpP68NlfYGE1O9DafgrmFBUlgpoYeI",
authDomain: "x-cargo-exprees.firebaseapp.com",
databaseURL: "https://x-cargo-exprees-default-rtdb.firebaseio.com",
projectId: "x-cargo-exprees",
storageBucket: "x-cargo-exprees.appspot.com",
messagingSenderId: "1082201867958",
appId: "1:1082201867958:web:d6600fbc82085b0b62c817"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const fetchBtn=document.getElementById("fetchBtn");
const updateBtn=document.getElementById("updateBtn");

// Signature Canvas
const canvas=document.getElementById("signatureCanvas");
const ctx=canvas.getContext("2d");
let drawing=false;
canvas.addEventListener("mousedown",e=>{drawing=true;ctx.beginPath();ctx.moveTo(e.offsetX,e.offsetY);});
canvas.addEventListener("mousemove",e=>{if(drawing){ctx.lineTo(e.offsetX,e.offsetY);ctx.strokeStyle=document.getElementById("signatureColor").value;ctx.lineWidth=2;ctx.stroke();}});
canvas.addEventListener("mouseup",()=>drawing=false);
canvas.addEventListener("mouseout",()=>drawing=false);

// Stamp selection and upload
const stampsContainer=document.getElementById("stampsContainer");
function addDraggableStamp(url){
  const img=document.createElement("img");
  img.src=url; img.className="draggable-stamp"; img.style.left="10px"; img.style.top="10px";
  stampsContainer.appendChild(img);
  let offsetX,offsetY,isDragging=false;
  img.addEventListener("mousedown",e=>{isDragging=true;offsetX=e.offsetX;offsetY=e.offsetY;});
  document.addEventListener("mousemove",e=>{if(!isDragging)return; const rect=stampsContainer.getBoundingClientRect(); img.style.left=(e.clientX-rect.left-offsetX)+"px"; img.style.top=(e.clientY-rect.top-offsetY)+"px";});
  document.addEventListener("mouseup",()=>{isDragging=false;});
}

document.querySelectorAll(".stamp").forEach(stamp=>{
  stamp.addEventListener("click",()=>{addDraggableStamp(stamp.src);});
});
document.getElementById("uploadStamp").addEventListener("change",e=>{
  const file=e.target.files[0]; if(file){const url=URL.createObjectURL(file); addDraggableStamp(url);}
});

// Fetch package info
fetchBtn.addEventListener("click",async()=>{
  const trackingId=document.getElementById("trackingId").value.trim();
  if(!trackingId)return alert("Enter Tracking ID");
  const dbRef=ref(db);
  const snapshot=await get(child(dbRef,"packages/"+trackingId));
  if(!snapshot.exists())return alert("‚ùå Package not found");
  const data=snapshot.val();
  updateBtn.disabled=false; document.getElementById("receipt").style.display="block";
  document.getElementById("rTracking").textContent=data.trackingId;
  document.getElementById("rSender").textContent=data.sender;
  document.getElementById("rReceiver").textContent=data.receiver;
  document.getElementById("rAddress").textContent=data.address;
  document.getElementById("rShip").textContent=data.shipmentDate;
  document.getElementById("rExpected").textContent=data.expectedDate;
  document.getElementById("rWeight").textContent=data.weight;
  document.getElementById("rQuantity").textContent=data.quantity;
  document.getElementById("rDesc").textContent=data.description;
  document.getElementById("headerLogo").src=data.logoURL||"";
  const imageSection=document.getElementById("imageSection"); imageSection.innerHTML="";
  if(data.packageImages){Object.values(data.packageImages).forEach(url=>{ imageSection.innerHTML+=`<img src="${url}" alt="Package Image">`;}); }
  document.getElementById("status").value=data.status||"Pending";
  document.getElementById("statusColor").value=data.statusColor||"#007bff";
  document.getElementById("warningText").value=data.warningText||"";
  document.getElementById("warningColor").value=data.warningColor||"#ff0000";
  document.getElementById("showWarning").checked=data.showWarning||false;
  renderPreview();
});

function renderPreview(){
  const status=document.getElementById("status").value;
  const color=document.getElementById("statusColor").value;
  const warning=document.getElementById("warningText").value;
  const warningColor=document.getElementById("warningColor").value;
  const showWarning=document.getElementById("showWarning").checked;
  document.getElementById("statusBox").innerHTML=`<span class="status-badge" style="background:${color}">${status}</span>`;
  document.getElementById("warningBox").innerHTML=showWarning?`<div class="warning-box" style="color:${warningColor}">${warning}</div>`:"";
  document.getElementById("selectedSignature").innerHTML=`<img src="${canvas.toDataURL()}" width="200">`;
}

// Update package
document.getElementById("statusForm").addEventListener("submit",async e=>{
  e.preventDefault();
  const trackingId=document.getElementById("trackingId").value.trim();
  if(!trackingId)return alert("Enter Tracking ID");
  const newStatus=document.getElementById("status").value;
  const statusColor=document.getElementById("statusColor").value;
  const warningText=document.getElementById("warningText").value;
  const warningColor=document.getElementById("warningColor").value;
  const showWarning=document.getElementById("showWarning").checked;
  const signatureData=canvas.toDataURL();
  const stamps=[];
  document.querySelectorAll("#stampsContainer img").forEach(s=>stamps.push({src:s.src,left:s.style.left,top:s.style.top}));
  await update(ref(db,"packages/"+trackingId),{
    status:newStatus,statusColor,warningText,warningColor,showWarning,signature:signatureData,stamps:stamps
  });
  alert("‚úÖ Package updated!");
  renderPreview();
});

// PDF Download with stamps & signature
document.getElementById("downloadPDF").addEventListener("click", async ()=>{
  const { jsPDF } = window.jspdf;
  const element=document.getElementById("receipt");
  const clone=element.cloneNode(true);
  clone.style.position="relative";
  clone.querySelectorAll(".draggable-stamp").forEach(img=>{
    img.style.position="absolute";
  });
  document.body.append
