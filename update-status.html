<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üöö X-Cargo Express - Update Package Status</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {font-family:"Segoe UI",sans-serif;background:#f5f7fb;color:#333;padding:25px;}
h2{text-align:center;margin-bottom:25px;color:#007bff;}
form{max-width:650px;margin:auto;background:#fff;padding:25px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
label{display:block;margin-top:10px;font-weight:500;}
input,select,textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:5px;font-size:15px;}
button{background:#007bff;color:#fff;border:none;padding:12px;border-radius:6px;width:100%;margin-top:20px;font-size:16px;cursor:pointer;transition:0.3s;}
button:hover{background:#0056b3;}
.receipt{display:none;background:#fff;padding:25px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);max-width:700px;margin:30px auto;position:relative;}
.header{text-align:center;border-bottom:2px solid #007bff;padding-bottom:10px;margin-bottom:15px;}
.header img{width:80px;height:auto;display:block;margin:0 auto 8px;}
.header h2{margin:5px 0;}
.header p{margin:0;font-size:13px;color:#666;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
table td,table th{padding:8px;border:1px solid #ccc;font-size:14px;}
table th{background:#f1f1f1;text-align:left;}
.status-box{text-align:center;margin-top:10px;}
.status-badge{display:inline-block;padding:6px 14px;border-radius:20px;color:#fff;font-weight:bold;}
.warning-box{text-align:center;font-weight:bold;margin-top:10px;}
.pay-button{display:block;background:#28a745;color:#fff;padding:10px 15px;border:none;border-radius:6px;text-align:center;margin:10px auto;cursor:pointer;text-decoration:none;}
.images{text-align:center;margin-top:15px;}
.images img{max-width:220px;margin:8px;border-radius:6px;}
.actions{text-align:center;margin-top:15px;}
.actions button{width:auto;margin:5px;padding:10px 15px;border-radius:6px;}
.actions .pdf{background:#ffc107;}
.actions .print{background:#17a2b8;}
.actions .img{background:#28a745;}
.picker-container{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;justify-content:center;}
.picker-container img{width:100px;cursor:pointer;border:2px solid transparent;border-radius:6px;transition:0.2s;}
.picker-container img.selected{border-color:#007bff;}
.signature-canvas{border:1px solid #ccc;margin-top:10px;cursor:crosshair;}
.draggable-stamp{position:absolute;width:100px;cursor:move;z-index:1000;}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<h2>üöö Update Package Status</h2>

<form id="statusForm">
<label>Enter Tracking ID</label>
<input type="text" id="trackingId" placeholder="e.g. XCE123456" required>
<button type="button" id="fetchBtn">üîç Search Package</button>

<label>Change Status</label>
<select id="status">
<option>Pending</option>
<option>Processing</option>
<option>In Transit</option>
<option>On Hold</option>
<option>Suspended</option>
<option>Delivered</option>
<option>Not Delivered Yet</option>
</select>

<label>Custom Status Color</label>
<input type="color" id="statusColor" value="#007bff">

<h3>‚ö†Ô∏è Warning Settings</h3>
<label><input type="checkbox" id="showWarning"> Show Warning Message</label>
<textarea id="warningText" placeholder="‚ö†Ô∏è Failure to verify may result in account lock!"></textarea>
<label>Warning Text Color</label>
<input type="color" id="warningColor" value="#ff0000">

<h3>üí∞ Payment Option</h3>
<label><input type="checkbox" id="addPay"> Add Pay Button</label>
<input type="text" id="payURL" placeholder="Enter payment URL" disabled>

<h3>üñã Add Signature</h3>
<canvas id="signatureCanvas" class="signature-canvas" width="400" height="150"></canvas>
<label>Pick Signature Color</label>
<input type="color" id="signatureColor" value="#000000">

<h3>üè∑ Add Stamp</h3>
<input type="file" id="uploadStamp" accept="image/*">
<div class="picker-container" id="stampPicker">
  <img src="https://i.postimg.cc/3x1sZsLz/approved.png" alt="Approved" class="stamp">
  <img src="https://i.postimg.cc/d3vY7cQm/rejected.png" alt="Rejected" class="stamp">
</div>

<button type="submit" id="updateBtn" disabled>‚úÖ Update Status</button>
</form>

<div id="receipt" class="receipt">
<div class="header">
<img id="headerLogo" src="" alt="Company Logo">
<h2>X-Cargo Express</h2>
<p>123 Express Avenue, Florida, USA</p>
<p>Email: support@xcargoexpress.com | Tel: +1-800-555-XCEX</p>
</div>

<div class="status-box" id="statusBox"></div>

<table>
<tr><th>Tracking ID</th><td id="rTracking"></td></tr>
<tr><th>Sender</th><td id="rSender"></td></tr>
<tr><th>Receiver</th><td id="rReceiver"></td></tr>
<tr><th>Address</th><td id="rAddress"></td></tr>
<tr><th>Shipment Date</th><td id="rShip"></td></tr>
<tr><th>Expected Delivery</th><td id="rExpected"></td></tr>
<tr><th>Weight</th><td id="rWeight"></td></tr>
<tr><th>Quantity</th><td id="rQuantity"></td></tr>
<tr><th>Description</th><td id="rDesc"></td></tr>
</table>

<div id="warningBox"></div>
<div id="payBox" style="text-align:center;"></div>
<div class="images" id="imageSection"></div>
<div id="stampsContainer" style="position:relative; min-height:50px;"></div>
<div id="selectedSignature" style="text-align:center; margin-top:10px;"></div>

<div class="actions">
<button class="print" onclick="window.print()">üñ® Print</button>
<button class="pdf" id="downloadPDF">‚¨á PDF</button>
<button class="img" id="saveImage">üñº Save Image</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

const firebaseConfig = {
apiKey: "AIzaSyBLYDpP68NlfYGE1O9DafgrmFBUlgpoYeI",
authDomain: "x-cargo-exprees.firebaseapp.com",
databaseURL: "https://x-cargo-exprees-default-rtdb.firebaseio.com",
projectId: "x-cargo-exprees",
storageBucket: "x-cargo-exprees.appspot.com",
messagingSenderId: "1082201867958",
appId: "1:1082201867958:web:d6600fbc82085b0b62c817"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Elements
const fetchBtn=document.getElementById("fetchBtn");
const updateBtn=document.getElementById("updateBtn");
const payCheckbox=document.getElementById("addPay");
const payInput=document.getElementById("payURL");
const statusInput=document.getElementById("status");
const statusColorInput=document.getElementById("statusColor");
const showWarningCheckbox=document.getElementById("showWarning");
const warningTextInput=document.getElementById("warningText");
const warningColorInput=document.getElementById("warningColor");
const signatureCanvas=document.getElementById("signatureCanvas");
const ctx=signatureCanvas.getContext("2d");

payCheckbox.addEventListener("change",()=>{payInput.disabled=!payCheckbox.checked; renderPreview();});

// Signature drawing
let drawing=false;
signatureCanvas.addEventListener("mousedown",e=>{drawing=true;ctx.beginPath();ctx.moveTo(e.offsetX,e.offsetY);});
signatureCanvas.addEventListener("mousemove",e=>{if(drawing){ctx.lineTo(e.offsetX,e.offsetY);ctx.strokeStyle=document.getElementById("signatureColor").value;ctx.lineWidth=2;ctx.stroke(); renderPreview();}});
signatureCanvas.addEventListener("mouseup",()=>drawing=false);
signatureCanvas.addEventListener("mouseout",()=>drawing=false);

// Stamp picker & upload
const stampsContainer=document.getElementById("stampsContainer");
function addDraggableStamp(url){
  const img=document.createElement("img");
  img.src=url; img.className="draggable-stamp"; img.style.left="10px"; img.style.top="10px";
  stampsContainer.appendChild(img);
  let offsetX,offsetY,isDragging=false;
  img.addEventListener("mousedown",e=>{isDragging=true; offsetX=e.offsetX; offsetY=e.offsetY;});
  document.addEventListener("mousemove",e=>{if(isDragging){const rect=stampsContainer.getBoundingClientRect(); img.style.left=(e.clientX-rect.left-offsetX)+"px"; img.style.top=(e.clientY-rect.top-offsetY)+"px";}});
  document.addEventListener("mouseup",()=>{isDragging=false;});
}
document.querySelectorAll(".stamp").forEach(s=>s.addEventListener("click",()=>addDraggableStamp(s.src)));
document.getElementById("uploadStamp").addEventListener("change",e=>{const file=e.target.files[0];if(file){addDraggableStamp(URL.createObjectURL(file));}});

// Render preview
function renderPreview(){
  document.getElementById("statusBox").innerHTML=`<span class="status-badge" style="background:${statusColorInput.value}">${statusInput.value}</span>`;
  document.getElementById("warningBox").innerHTML=showWarningCheckbox.checked?`<div class="warning-box" style="color:${warningColorInput.value}">${warningTextInput.value}</div>`:"";
  document.getElementById("payBox").innerHTML=(payCheckbox.checked && payInput.value)?`<a class="pay-button" href="${payInput.value}" target="_self">üí∞ Pay Here</a>`:"";
  document.getElementById("selectedSignature").innerHTML=`<img src="${signatureCanvas.toDataURL()}" width="200">`;
}

// Fetch package
fetchBtn.addEventListener("click",async()=>{
  const id=document.getElementById("trackingId").value.trim();
  if(!id){alert("Enter Tracking ID"); return;}
  const snap=await get(ref(db,"packages/"+id));
  if(!snap.exists()){alert("Package not found"); return;}
  const data=snap.val();
  updateBtn.disabled=false;
  document.getElementById("receipt").style.display="block";
  document.getElementById("rTracking").textContent=data.trackingId||"";
  document.getElementById("rSender").textContent=data.sender||"";
  document.getElementById("rReceiver").textContent=data.receiver||"";
  document.getElementById("rAddress").textContent=data.address||"";
  document.getElementById("rShip").textContent=data.shipmentDate||"";
  document.getElementById("rExpected").textContent=data.expectedDate||"";
  document.getElementById("rWeight").textContent=data.weight||"";
  document.getElementById("rQuantity").textContent=data.quantity||"";
  document.getElementById("rDesc").textContent=data.description||"";
  document.getElementById("headerLogo").src=data.logoURL||"";
  statusInput.value=data.status||"Pending";
  statusColorInput.value=data.statusColor||"#007bff";
  showWarningCheckbox.checked=data.showWarning||false;
  warningTextInput.value=data.warningText||"";
  warningColorInput.value=data.warningColor||"#ff0000";
  payCheckbox.checked=data.showPay||false;
  payInput.value=data.payURL||"";
  payInput.disabled=!payCheckbox.checked;
  renderPreview();
});

// Update Firebase
document.getElementById("statusForm").addEventListener("submit",async e=>{
  e.preventDefault();
  const id=document.getElementById("trackingId").value.trim();
  if(!id){alert("Enter Tracking ID"); return;}
  const stamps=[];
  document.querySelectorAll(".draggable-stamp").forEach(s=>stamps.push({src:s.src,left:s.style.left,top:s.style.top}));
  await update(ref(db,"packages/"+id),{
    status:statusInput.value,
    statusColor:statusColorInput.value,
    showWarning:showWarningCheckbox.checked,
    warningText:warningTextInput.value,
    warningColor:warningColorInput.value,
    showPay:payCheckbox.checked,
    payURL:payInput.value,
    signature:signatureCanvas.toDataURL(),
    stamps:stamps
  });
  alert("‚úÖ Status updated successfully!");
});

// Live updates
[statusInput,statusColorInput,showWarningCheckbox,warningTextInput,warningColorInput,payInput].forEach(el=>el.addEventListener("input",renderPreview));
document.getElementById("signatureColor").addEventListener("input",renderPreview);
</script>
</body>
</html>
