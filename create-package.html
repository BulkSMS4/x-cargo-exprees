<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üì¶ X-Cargo Express - Create Package</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#f4f4f9; }
    h2 { text-align:center; }
    form { max-width: 650px; margin: auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    label { display:block; margin-top:10px; font-weight:bold; }
    input, textarea, select { width:100%; padding:8px; margin-top:5px; border-radius:5px; border:1px solid #ccc; }
    .receipt { max-width:650px; margin:20px auto; padding:20px; border-radius:10px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.1); display:none; }
    .warning-box { font-weight:bold; padding:10px; border-radius:5px; margin-top:10px; }
    .package-img, .logo-img { max-width:200px; margin:10px auto; display:block; }
    button { padding:10px 15px; margin-top:15px; border:none; background:#007bff; color:#fff; border-radius:5px; cursor:pointer; }
    button:hover { background:#0056b3; }
    table { width:100%; border-collapse: collapse; margin-top:10px; }
    table td, table th { border:1px solid #ccc; padding:8px; text-align:left; }
    .receipt-header { text-align:center; margin-bottom:15px; }
    .signature { margin-top:40px; text-align:center; }
    .action-buttons { text-align:center; margin-top:20px; }
    .action-buttons button { margin:5px; }
  </style>
  <!-- html2canvas + jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<h2>üì¶ Create New Package</h2>
<form id="packageForm">
  <label>Tracking ID</label>
  <input type="text" id="trackingId" placeholder="e.g. XCE123456789">

  <label>Sender</label>
  <input type="text" id="sender" placeholder="e.g. John Smith, New York">

  <label>Receiver</label>
  <input type="text" id="receiver" placeholder="e.g. Mary Johnson, London">

  <label>Delivery Address</label>
  <textarea id="address" placeholder="e.g. 221B Baker Street, London"></textarea>

  <label>Status</label>
  <input type="text" id="status" placeholder="e.g. In Transit">

  <label>Shipment Date</label>
  <input type="date" id="shipmentDate">

  <label>Expected Delivery</label>
  <input type="date" id="expectedDate">

  <label>Weight</label>
  <input type="text" id="weight" placeholder="e.g. 12kg">

  <label>Description</label>
  <textarea id="description" placeholder="e.g. Fragile glass items"></textarea>

  <label>Quantity</label>
  <input type="number" id="quantity" placeholder="e.g. 3">

  <label>Upload Package Picture</label>
  <input type="file" id="packageImage" accept="image/*">

  <label>Upload Company Logo</label>
  <input type="file" id="logoUpload" accept="image/*">

  <h3>‚ö†Ô∏è Warning Message</h3>
  <textarea id="warningText" placeholder="e.g. ‚ö†Ô∏è Fragile! Handle with care"></textarea>
  <label><input type="checkbox" id="showWarning"> Show Warning on Receipt</label>
  <label>Warning Color</label>
  <input type="color" id="warningColor" value="#ff0000">

  <div style="text-align:center;">
    <button type="button" onclick="generateReceipt()">‚úÖ Generate Receipt</button>
  </div>
</form>

<!-- Receipt -->
<div class="receipt" id="receipt">
  <div class="receipt-header">
    <img id="receiptLogo" class="logo-img" style="display:none;">
    <h2 id="receiptLogoText">X-Cargo Express</h2>
    <p><strong>Date:</strong> <span id="todayDate"></span></p>
    <h3>Shipment Receipt</h3>
  </div>
  
  <table>
    <tbody id="receiptContent"></tbody>
  </table>

  <div id="receiptWarning"></div>

  <h4 style="text-align:center; margin-top:20px;">üì¶ Package Image</h4>
  <img id="receiptImage" class="package-img" style="display:none;">

  <div class="signature">
    <p>__________________________</p>
    <p>Authorized Signature</p>
  </div>
</div>

<div class="action-buttons">
  <button onclick="printReceipt()">üñ®Ô∏è Print</button>
  <button onclick="downloadPDF()">üìÑ Download PDF</button>
  <button onclick="saveImage()">üñºÔ∏è Save to Gallery</button>
</div>

<script type="module">
// ‚úÖ IMPORT FIREBASE
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

// ‚úÖ FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyBLYDpP68NlfYGE1O9DafgrmFBUlgpoYeI",
  authDomain: "x-cargo-exprees.firebaseapp.com",
  databaseURL: "https://x-cargo-exprees-default-rtdb.firebaseio.com",
  projectId: "x-cargo-exprees",
  storageBucket: "x-cargo-exprees.appspot.com",
  messagingSenderId: "1082201867958",
  appId: "1:1082201867958:web:d6600fbc82085b0b62c817"
};

// ‚úÖ Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Today's date
document.getElementById("todayDate").innerText = new Date().toLocaleDateString();

// ‚úÖ Save package to Firebase
function savePackageToFirebase(data) {
  const packageRef = ref(db, "packages/" + data.trackingId);
  set(packageRef, data)
    .then(() => {
      alert("‚úÖ Package saved successfully to Firebase!");
    })
    .catch((err) => {
      console.error("‚ùå Error saving:", err);
      alert("Error saving package. Check console for details.");
    });
}

// ‚úÖ Generate Receipt
function generateReceipt() {
  const data = {
    trackingId: document.getElementById("trackingId").value,
    sender: document.getElementById("sender").value,
    receiver: document.getElementById("receiver").value,
    address: document.getElementById("address").value,
    status: document.getElementById("status").value,
    shipmentDate: document.getElementById("shipmentDate").value,
    expectedDate: document.getElementById("expectedDate").value,
    weight: document.getElementById("weight").value,
    description: document.getElementById("description").value,
    quantity: document.getElementById("quantity").value,
  };

  // Fill receipt
  const r = document.getElementById("receiptContent");
  r.innerHTML = `
    <tr><td><strong>Tracking ID</strong></td><td>${data.trackingId}</td></tr>
    <tr><td><strong>Sender</strong></td><td>${data.sender}</td></tr>
    <tr><td><strong>Receiver</strong></td><td>${data.receiver}</td></tr>
    <tr><td><strong>Delivery Address</strong></td><td>${data.address}</td></tr>
    <tr><td><strong>Status</strong></td><td>${data.status}</td></tr>
    <tr><td><strong>Shipment Date</strong></td><td>${data.shipmentDate}</td></tr>
    <tr><td><strong>Expected Delivery</strong></td><td>${data.expectedDate}</td></tr>
    <tr><td><strong>Weight</strong></td><td>${data.weight}</td></tr>
    <tr><td><strong>Description</strong></td><td>${data.description}</td></tr>
    <tr><td><strong>Quantity</strong></td><td>${data.quantity}</td></tr>
  `;

  // Warning box
  const warningBox = document.getElementById("receiptWarning");
  if (document.getElementById("showWarning").checked && document.getElementById("warningText").value.trim() !== "") {
    warningBox.innerHTML = `<div class="warning-box" style="color:${document.getElementById("warningColor").value}; text-align:center;">
      ${document.getElementById("warningText").value}
    </div>`;
  } else {
    warningBox.innerHTML = "";
  }

  document.getElementById("receipt").style.display = "block";

  if (data.trackingId.trim() !== "") {
    savePackageToFirebase(data);
  } else {
    alert("‚ö†Ô∏è Please enter a Tracking ID before saving!");
  }
}

// ‚úÖ Handle Images
document.getElementById("packageImage").addEventListener("change", function() {
  const file = this.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById("receiptImage").src = e.target.result;
      document.getElementById("receiptImage").style.display = "block";
    };
    reader.readAsDataURL(file);
  }
});

document.getElementById("logoUpload").addEventListener("change", function() {
  const file = this.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById("receiptLogo").src = e.target.result;
      document.getElementById("receiptLogo").style.display = "block";
      document.getElementById("receiptLogoText").style.display = "none";
    };
    reader.readAsDataURL(file);
  }
});

// ‚úÖ Print
function printReceipt() {
  const printContents = document.getElementById("receipt").innerHTML;
  const win = window.open("", "", "width=700,height=600");
  win.document.write("<html><head><title>Print Receipt</title></head><body>");
  win.document.write(printContents);
  win.document.write("</body></html>");
  win.document.close();
  win.print();
}

// ‚úÖ PDF
async function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const receipt = document.getElementById("receipt");
  const canvas = await html2canvas(receipt);
  const imgData = canvas.toDataURL("image/png");
  const pdf = new jsPDF("p", "mm", "a4");
  const imgProps = pdf.getImageProperties(imgData);
  const pdfWidth = pdf.internal.pageSize.getWidth();
  const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
  pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
  pdf.save("shipment_receipt.pdf");
}

// ‚úÖ Save as Image
async function saveImage() {
  const receipt = document.getElementById("receipt");
  const canvas = await html2canvas(receipt);
  const link = document.createElement("a");
  link.download = "shipment_receipt.png";
  link.href = canvas.toDataURL("image/png");
  link.click();
}

// Expose functions to global scope
window.generateReceipt = generateReceipt;
window.printReceipt = printReceipt;
window.downloadPDF = downloadPDF;
window.saveImage = saveImage;
</script>
</body>
</html>
