<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üíº X-Cargo Express - View All Invoices</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: #f0f2f7;
  color: #333;
  padding: 20px;
  margin: 0;
}
h2 {
  text-align: center;
  margin-bottom: 20px;
  color: #007bff;
}
#searchContainer {
  max-width: 800px;
  margin: 0 auto 30px auto;
  display: flex;
  gap: 10px;
}
#searchInput {
  flex: 1;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 16px;
}
#searchBtn, #clearBtn {
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  background: #007bff;
  color: #fff;
  cursor: pointer;
  font-weight: bold;
  transition: 0.3s;
}
#searchBtn:hover, #clearBtn:hover {
  background: #0056b3;
}
.invoice-card {
  background: #fff;
  padding: 20px;
  margin-bottom: 20px;
  border-radius: 12px;
  box-shadow: 0 6px 15px rgba(0,0,0,0.1);
  transition: transform 0.2s, box-shadow 0.2s;
  position: relative;
}
.invoice-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}
.invoice-card.highlight {
  border: 2px solid #007bff;
  box-shadow: 0 8px 25px rgba(0,123,255,0.3);
}
.invoice-card h3 {
  margin: 0 0 10px 0;
  color: #007bff;
}
.status-badge {
  display: inline-block;
  padding: 5px 12px;
  border-radius: 20px;
  color: #fff;
  font-weight: bold;
  margin-bottom: 10px;
  font-size: 14px;
}
.warning-box {
  margin-top: 10px;
  font-weight: bold;
  font-size: 14px;
}
.pay-button {
  display: inline-block;
  padding: 10px 18px;
  border-radius: 8px;
  color: #fff;
  text-decoration: none;
  margin-top: 10px;
  font-weight: bold;
  transition: 0.3s;
}
.pay-button:hover {
  opacity: 0.85;
}
.images img {
  max-width: 120px;
  margin: 5px;
  border-radius: 8px;
  border: 1px solid #ccc;
}
.stamps img {
  width: 80px;
  margin: 5px;
  border-radius: 6px;
}
.delete-btn, .view-btn, .copy-btn, .edit-btn {
  display: inline-block;
  padding: 8px 14px;
  border-radius: 8px;
  text-decoration: none;
  margin: 5px 5px 0 0;
  font-weight: bold;
  cursor: pointer;
  font-size: 14px;
  transition: 0.3s;
}
.delete-btn { background: #dc3545; color: #fff; }
.delete-btn:hover { background: #a71d2a; }
.view-btn { background: #17a2b8; color: #fff; }
.view-btn:hover { background: #117a8b; }
.edit-btn { background: #ffc107; color: #fff; }
.edit-btn:hover { background: #cc9a06; }
.copy-btn { background: #28a745; color: #fff; }
.copy-btn:hover { background: #1c6e3b; }
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
table td, table th {
  padding: 8px;
  border: 1px solid #e0e0e0;
  font-size: 14px;
}
table th {
  background: #f8f9fa;
  text-align: left;
}
</style>
</head>
<body>

<h2>üíº All Package Invoices</h2>

<div id="searchContainer">
  <input type="text" id="searchInput" placeholder="Search Tracking ID...">
  <button id="searchBtn">üîç Search</button>
  <button id="clearBtn">‚ùå Clear</button>
</div>

<div id="invoicesContainer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getDatabase, ref, get, child, remove } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBLYDpP68NlfYGE1O9DafgrmFBUlgpoYeI",
  authDomain: "x-cargo-exprees.firebaseapp.com",
  databaseURL: "https://x-cargo-exprees-default-rtdb.firebaseio.com",
  projectId: "x-cargo-exprees",
  storageBucket: "x-cargo-exprees.appspot.com",
  messagingSenderId: "1082201867958",
  appId: "1:1082201867958:web:d6600fbc82085b0b62c817"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const invoicesContainer = document.getElementById("invoicesContainer");
let allPackages = [];

async function loadInvoices() {
  const dbRef = ref(db);
  const snapshot = await get(child(dbRef,"packages"));
  if(!snapshot.exists()){invoicesContainer.innerHTML="<p>No invoices found.</p>"; return;}
  allPackages = Object.values(snapshot.val());
  displayInvoices(allPackages);
}

function displayInvoices(packages){
  invoicesContainer.innerHTML="";
  packages.forEach(pkg=>{
    const card = document.createElement("div");
    card.className = "invoice-card";
    card.dataset.tracking = pkg.trackingId || "";

    card.innerHTML = `
      <h3>Tracking ID: ${pkg.trackingId||''}</h3>
      <div class="status"><span class="status-badge" style="background:${pkg.statusColor||'#007bff'}">${pkg.status||'Pending'}</span></div>
      <table>
        <tr><th>Sender</th><td>${pkg.sender||''}</td></tr>
        <tr><th>Receiver</th><td>${pkg.receiver||''}</td></tr>
        <tr><th>Address</th><td>${pkg.address||''}</td></tr>
        <tr><th>Shipment Date</th><td>${pkg.shipmentDate||''}</td></tr>
        <tr><th>Expected Delivery</th><td>${pkg.expectedDate||''}</td></tr>
        <tr><th>Weight</th><td>${pkg.weight||''}</td></tr>
        <tr><th>Quantity</th><td>${pkg.quantity||''}</td></tr>
        <tr><th>Description</th><td>${pkg.description||''}</td></tr>
      </table>
      <div class="warning-box">${pkg.showWarning?`‚ö†Ô∏è <span style="color:${pkg.warningColor||'#ff0000'}">${pkg.warningText||''}</span>`:''}</div>
      <div class="pay-button-container">
        ${pkg.showPay && pkg.payURL?`<a href="${pkg.payURL}" class="pay-button" style="background-color:${pkg.payColor||'#28a745'}" target="_self">${pkg.payText||'Pay Now'}</a>`:''}
      </div>
      <div class="images">
        ${pkg.packageImages?Object.values(pkg.packageImages).map(url=>`<img src="${url}" alt="Package Image">`).join(''):''}
      </div>
      <div class="stamps">
        ${pkg.stamps?pkg.stamps.map(url=>`<img src="${url}" alt="Stamp">`).join(''):''}
      </div>
      <div style="margin-top:10px;">
        <button class="view-btn">View</button>
        <button class="edit-btn">Edit</button>
        <button class="copy-btn">Copy Tracking</button>
        <button class="delete-btn">Delete</button>
      </div>
    `;

    // DELETE
    card.querySelector(".delete-btn").addEventListener("click", async ()=>{
      if(confirm(`Delete package ${pkg.trackingId}?`)){
        await remove(ref(db,"packages/"+pkg.trackingId));
        loadInvoices();
      }
    });

    // VIEW
    card.querySelector(".view-btn").addEventListener("click", ()=>{
      window.location.href = `track.html?id=${pkg.trackingId}`;
    });

    // EDIT
    card.querySelector(".edit-btn").addEventListener("click", ()=>{
      window.location.href = `build.html?edit=${pkg.trackingId}`;
    });

    // COPY
    card.querySelector(".copy-btn").addEventListener("click", ()=>{
      navigator.clipboard.writeText(pkg.trackingId).then(()=>alert(`Tracking ID ${pkg.trackingId} copied!`));
    });

    invoicesContainer.appendChild(card);
  });
}

// SEARCH
document.getElementById("searchBtn").addEventListener("click", ()=>{
  const query = document.getElementById("searchInput").value.trim().toLowerCase();
  let found = false;
  document.querySelectorAll(".invoice-card").forEach(card=>{
    if(card.dataset.tracking.toLowerCase().includes(query) && query!==""){
      card.classList.add("highlight");
      found = true;
    } else {
      card.classList.remove("highlight");
    }
  });
  if(!found && query!==""){ alert("‚ùå No package found with that Tracking ID"); }
});

// CLEAR SEARCH
document.getElementById("clearBtn").addEventListener("click", ()=>{
  document.getElementById("searchInput").value="";
  document.querySelectorAll(".invoice-card").forEach(card=>card.classList.remove("highlight"));
});

loadInvoices();
</script>

</body>
</html>
