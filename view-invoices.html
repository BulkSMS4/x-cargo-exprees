<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>X-Cargo Express ‚Äì All Invoices</title>
<style>
  body {font-family: Inter, "Segoe UI", Arial; background: #f4f6fb; color: #222; padding: 20px; max-width: 1000px; margin: auto;}
  h1 {color: #004080; text-align: center; margin-bottom: 20px;}

  .search-container {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    position: relative;
  }

  .search-container input[type="text"],
  .search-container input[type="date"] {
    padding: 10px 36px 10px 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 16px;
    flex: 1;
  }

  .search-container button {
    padding: 10px 16px;
    border-radius: 8px;
    border: none;
    background: #004080;
    color: #fff;
    font-weight: bold;
    cursor: pointer;
  }

  .clear-btn {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    font-size: 18px;
    cursor: pointer;
    color: #999;
    display: none;
  }
  .clear-btn:hover { color: #333; }

  table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 6px 18px rgba(0,0,0,.08);
  }
  th, td {padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee;}
  th {background: #004080; color: #fff; font-weight: 600; cursor: pointer;}
  tr:hover {background: #f1f9ff;}

  button {padding: 6px 12px; margin-right: 5px; background: #004080; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;}
  button:hover {background: #003366;}
  .delete-btn {background: #d9534f;}
  .delete-btn:hover {background: #c12e2a;}
  .status {padding: 4px 8px; border-radius: 12px; color: #fff; font-weight: 600; display: inline-block;}

  mark { background: yellow; color: black; }
  .highlight-row { background-color: #fffa8c !important; }

</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getDatabase, ref, get, remove } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBLYDpP68NlfYGE1O9DafgrmFBUlgpoYeI",
  authDomain: "x-cargo-exprees.firebaseapp.com",
  databaseURL: "https://x-cargo-exprees-default-rtdb.firebaseio.com",
  projectId: "x-cargo-exprees",
  storageBucket: "x-cargo-exprees.appspot.com",
  messagingSenderId: "1082201867958",
  appId: "1:1082201867958:web:d6600fbc82085b0b62c817"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
let allPackages = [];

async function loadInvoices() {
  const snap = await get(ref(db, 'packages'));
  if (!snap.exists()) {
    document.getElementById("invoicesTableBody").innerHTML = '<tr><td colspan="7" style="text-align:center;">No packages found.</td></tr>';
    return;
  }
  allPackages = Object.entries(snap.val()).map(([id, pkg]) => ({ id, ...pkg }));
  renderTable(allPackages);
}

function renderTable(packages, highlight="") {
  const tableBody = document.getElementById("invoicesTableBody");
  tableBody.innerHTML = '';
  if (!packages.length) {
    tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">‚ùå No matching tracking number or package found.</td></tr>';
    return;
  }

  const regex = highlight ? new RegExp(`(${highlight.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, "gi") : null;

  packages.forEach(pkg => {
    const statusColor = pkg.statusColor || "#007bff";
    const tr = document.createElement("tr");

    // Highlight row if date within range
    const fromDate = document.getElementById("fromDate").value;
    const toDate = document.getElementById("toDate").value;
    let highlightRow = false;
    if(fromDate && pkg.shipmentDate >= fromDate) highlightRow = true;
    if(toDate && pkg.shipmentDate <= toDate) highlightRow = highlightRow && true;

    if(highlightRow) tr.classList.add('highlight-row');

    const highlightText = (text) => text && regex ? text.replace(regex, '<mark>$1</mark>') : (text || "-");

    tr.innerHTML = `
      <td>${highlightText(pkg.id)}</td>
      <td>${highlightText(pkg.sender)}</td>
      <td>${highlightText(pkg.receiver)}</td>
      <td><span class="status" style="background:${statusColor}">${highlightText(pkg.status)}</span></td>
      <td>${highlightText(pkg.shipmentDate)}</td>
      <td>
        <a href="invoice.html?id=${pkg.id}" target="_blank"><button>View</button></a>
        <button class="delete-btn" onclick="deletePackage('${pkg.id}')">Delete</button>
      </td>
    `;
    tableBody.appendChild(tr);
  });
}

function searchInvoices() {
  const textQuery = document.getElementById("searchInput").value.toLowerCase();
  const fromDate = document.getElementById("fromDate").value;
  const toDate = document.getElementById("toDate").value;

  document.getElementById("clearBtn").style.display = textQuery || fromDate || toDate ? "block" : "none";

  const filtered = allPackages.filter(pkg => {
    const matchesText = pkg.id.toLowerCase().includes(textQuery) ||
                        (pkg.sender && pkg.sender.toLowerCase().includes(textQuery)) ||
                        (pkg.receiver && pkg.receiver.toLowerCase().includes(textQuery));

    let matchesDate = true;
    if(fromDate) matchesDate = (pkg.shipmentDate || '') >= fromDate;
    if(toDate) matchesDate = matchesDate && (pkg.shipmentDate || '') <= toDate;

    return matchesText && matchesDate;
  });

  renderTable(filtered, textQuery);
}

function clearSearch() {
  document.getElementById("searchInput").value = '';
  document.getElementById("fromDate").value = '';
  document.getElementById("toDate").value = '';
  document.getElementById("clearBtn").style.display = "none";
  renderTable(allPackages);
}

function sortBy(field) {
  allPackages.sort((a, b) => {
    if (field === 'shipmentDate') return (a.shipmentDate || '').localeCompare(b.shipmentDate || '');
    if (field === 'status') return (a.status || '').localeCompare(b.status || '');
    return 0;
  });
  renderTable(allPackages);
}

async function deletePackage(id) {
  if (!confirm(`Are you sure you want to delete package ${id}? This action cannot be undone.`)) return;
  try {
    await remove(ref(db, `packages/${id}`));
    allPackages = allPackages.filter(pkg => pkg.id !== id);
    renderTable(allPackages);
    alert(`Package ${id} deleted successfully.`);
  } catch (err) {
    alert(`Error deleting package: ${err.message}`);
  }
}

window.onload = loadInvoices;
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById("searchInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter") searchInvoices();
  });
});
</script>
</head>
<body>
<h1>All Shipment Invoices</h1>

<div class="search-container">
  <div style="position:relative; flex:2;">
    <input type="text" id="searchInput" placeholder="Search by Package ID, Sender, or Receiver" oninput="searchInvoices()">
    <button id="clearBtn" class="clear-btn" onclick="clearSearch()">√ó</button>
  </div>
  <input type="date" id="fromDate">
  <input type="date" id="toDate">
  <button onclick="searchInvoices()">üîç Search</button>
</div>

<table>
  <thead>
    <tr>
      <th>Package ID</th>
      <th>Sender</th>
      <th>Receiver</th>
      <th onclick="sortBy('status')">Status ‚¨ç</th>
      <th onclick="sortBy('shipmentDate')">Shipment Date ‚¨ç</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="invoicesTableBody">
    <tr><td colspan="7" style="text-align:center;">Loading invoices...</td></tr>
  </tbody>
</table>
</body>
</html>
