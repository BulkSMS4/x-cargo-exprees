<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>X-Cargo Express ‚Äì All Invoices</title>
<style>
  body {font-family: Inter, "Segoe UI", Arial; background: #f4f6fb; color: #222; padding: 20px; max-width: 1000px; margin: auto;}
  h1 {color: #004080; text-align: center; margin-bottom: 20px;}

  .search-container {display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; position: relative;}
  .search-wrapper {position: relative; flex: 2;}
  .search-wrapper input[type="text"] {width: 100%; padding: 10px 36px 10px 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px;}
  .search-wrapper .clear-btn {position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: transparent; border: none; font-size: 18px; cursor: pointer; color: #999; display: none;}
  .search-wrapper .clear-btn:hover { color: #333; }
  .search-container button {padding: 10px 16px; border-radius: 8px; border: none; background: #004080; color: #fff; font-weight: bold; cursor: pointer;}

  table {width: 100%; border-collapse: collapse; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 6px 18px rgba(0,0,0,.08);}
  th, td {padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee;}
  th {background: #004080; color: #fff; font-weight: 600; cursor: pointer;}
  tr:hover {background: #f1f9ff;}
  button {padding: 6px 12px; margin-right: 5px; background: #004080; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;}
  button:hover {background: #003366;}
  .delete-btn {background: #d9534f;}
  .delete-btn:hover {background: #c12e2a;}
  .status {padding: 4px 8px; border-radius: 12px; color: #fff; font-weight: 600; display: inline-block;}
  mark { background: yellow; color: black; }
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getDatabase, ref, get, remove, onChildAdded } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBLYDpP68NlfYGE1O9DafgrmFBUlgpoYeI",
  authDomain: "x-cargo-exprees.firebaseapp.com",
  databaseURL: "https://x-cargo-exprees-default-rtdb.firebaseio.com",
  projectId: "x-cargo-exprees",
  storageBucket: "x-cargo-exprees.appspot.com",
  messagingSenderId: "1082201867958",
  appId: "1:1082201867958:web:d6600fbc82085b0b62c817"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
let allPackages = [];
let knownPackageIds = new Set();
let alertedPackages = new Set(); // track which packages have already triggered alert

const alertAudio = new Audio("https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"); // ringtone alert

async function loadInvoices() {
  const snap = await get(ref(db, 'packages'));
  if (!snap.exists()) {
    document.getElementById("invoicesTableBody").innerHTML = '<tr><td colspan="7" style="text-align:center;">No packages found.</td></tr>';
    return;
  }

  allPackages = Object.entries(snap.val()).map(([id, pkg]) => {
    knownPackageIds.add(id);
    return { id, ...pkg };
  });
  renderTable(allPackages);
  listenForNewPackages();
}

function renderTable(packages, highlight="") {
  const tableBody = document.getElementById("invoicesTableBody");
  tableBody.innerHTML = '';
  if (!packages.length) {
    tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">‚ùå No matching tracking number or package found.</td></tr>';
    return;
  }

  const regex = highlight ? new RegExp(`(${highlight.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, "gi") : null;

  packages.forEach(pkg => {
    const statusColor = pkg.statusColor || "#007bff";
    const tr = document.createElement("tr");

    const highlightText = (text) => text && regex ? text.replace(regex, '<mark>$1</mark>') : (text || "-");

    tr.innerHTML = `
      <td>${highlightText(pkg.id)}</td>
      <td>${highlightText(pkg.sender)}</td>
      <td>${highlightText(pkg.receiver)}</td>
      <td><span class="status" style="background:${statusColor}">${highlightText(pkg.status)}</span></td>
      <td>${highlightText(pkg.shipmentDate)}</td>
      <td>
        <a href="invoice.html?id=${pkg.id}" target="_blank"><button>View</button></a>
        <button class="delete-btn" onclick="deletePackage('${pkg.id}')">Delete</button>
      </td>
    `;
    tableBody.appendChild(tr);
  });
}

function searchInvoices() {
  const textQuery = document.getElementById("searchInput").value.toLowerCase();
  document.getElementById("clearBtn").style.display = textQuery ? "block" : "none";

  const filtered = allPackages.filter(pkg =>
    pkg.id.toLowerCase().includes(textQuery) ||
    (pkg.sender && pkg.sender.toLowerCase().includes(textQuery)) ||
    (pkg.receiver && pkg.receiver.toLowerCase().includes(textQuery))
  );

  renderTable(filtered, textQuery);
}

function clearSearch() {
  document.getElementById("searchInput").value = '';
  document.getElementById("clearBtn").style.display = "none";
  renderTable(allPackages);
  document.getElementById("searchInput").focus();
}

function sortBy(field) {
  allPackages.sort((a, b) => {
    if (field === 'shipmentDate') return (a.shipmentDate || '').localeCompare(b.shipmentDate || '');
    if (field === 'status') return (a.status || '').localeCompare(b.status || '');
    return 0;
  });
  renderTable(allPackages);
}

async function deletePackage(id) {
  if (!confirm(`Are you sure you want to delete package ${id}? This action cannot be undone.`)) return;
  try {
    await remove(ref(db, `packages/${id}`));
    allPackages = allPackages.filter(pkg => pkg.id !== id);
    knownPackageIds.delete(id);
    alertedPackages.delete(id);
    renderTable(allPackages);
    alert(`Package ${id} deleted successfully.`);
  } catch (err) {
    alert(`Error deleting package: ${err.message}`);
  }
}

function listenForNewPackages() {
  const packagesRef = ref(db, 'packages');
  onChildAdded(packagesRef, (snap) => {
    const pkg = snap.val();
    const id = snap.key;
    if (!knownPackageIds.has(id)) {
      knownPackageIds.add(id);
      allPackages.push({ id, ...pkg });
      renderTable(allPackages);
    }
    // play alert only once per package
    if (!alertedPackages.has(id)) {
      alertedPackages.add(id);
      alertAudio.play().catch(()=>{});
      console.log("New package alert: ", id);
    }
  });
}

window.onload = loadInvoices;
document.addEventListener('DOMContentLoaded', () => {
  const searchInput = document.getElementById("searchInput");
  const searchBtn = document.getElementById("searchBtn");
  const clearBtn = document.getElementById("clearBtn");

  searchInput.addEventListener("input", searchInvoices);
  searchInput.addEventListener("keydown", (e) => { if (e.key === "Enter") searchInvoices(); });
  searchBtn.addEventListener("click", searchInvoices);
  clearBtn.addEventListener("click", clearSearch);
});
</script>
</head>
<body>
<h1>All Shipment Invoices</h1>

<div class="search-container">
  <div class="search-wrapper">
    <input type="text" id="searchInput" placeholder="Search by Package ID, Sender, or Receiver">
    <button id="clearBtn" class="clear-btn">√ó</button>
  </div>
  <button id="searchBtn">üîç Search</button>
</div>

<table>
  <thead>
    <tr>
      <th>Package ID</th>
      <th>Sender</th>
      <th>Receiver</th>
      <th onclick="sortBy('status')">Status ‚¨ç</th>
      <th onclick="sortBy('shipmentDate')">Shipment Date ‚¨ç</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="invoicesTableBody">
    <tr><td colspan="7" style="text-align:center;">Loading invoices...</td></tr>
  </tbody>
</table>
</body>
</html>
